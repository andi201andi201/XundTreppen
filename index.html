<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Treppen-Challenge</title>
  <style>
    /* ‚Ä¶ (Deine bestehenden Styles unver√§ndert) ‚Ä¶ */
  </style>

  <!-- Stockwerk-Param-Sperre -->
  <script>
    function lockStock() {
      const sp = new URLSearchParams(location.search).get('stock');
      if (['1','2','3','4'].includes(sp)) {
        const el = document.getElementById('stockwerk');
        el.value = sp;
        el.disabled = true;
      }
    }
    window.addEventListener('DOMContentLoaded', lockStock);
    window.addEventListener('pageshow',      lockStock);
  </script>
</head>
<body>
  <header>
    <img src="https://i.postimg.cc/2qZmLMft/Xund-Treppen-logo.png" alt="Logo" class="logo">
    <!-- RELATIVER Link zur Selfie-Seite -->
    <a href="./selfie.html" class="selfie-btn" title="Selfie-Station">
      <img src="https://img.icons8.com/ios-filled/50/00796b/camera.png" alt="Selfie">
      Selfie-Station
    </a>
  </header>

  <h1>Treppen-Challenge</h1>

  <div id="countQuizBar">
    <div id="countdown">‚è≥ Lade...</div>
    <!-- RELATIVER Link zum Quiz -->
    <a href="./quiz.html" class="quiz-link">üöÄ Zum t√§glichen Quiz</a>
  </div>

  <!-- Punkt-Erfassung -->
  <label for="klasse">W√§hle deine Klasse:</label>
  <select id="klasse">
    <option value="">--Bitte w√§hlen--</option>
  </select>

  <label for="stockwerk">Angekommen im Stockwerk:</label>
  <select id="stockwerk">
    <option value="">-- Bitte w√§hlen --</option>
    <option value="1">1. Stock (1 Punkt)</option>
    <option value="2">2. Stock (2 Punkte)</option>
    <option value="3">3. Stock (3 Punkte)</option>
    <option value="4">4. Stock (4 Punkte)</option>
  </select>
  <button id="enterBtn" onclick="punkteSpeichern()">Punkte eintragen</button>
  <div id="output"></div>

  <!-- Ranglisten -->
  <div id="leaderContainer">
    <div id="topLeaderContainer">
      <div id="leaderboard"></div>
      <div id="dailyLeaderboard"></div>
    </div>
    <div id="lehrerliste"></div>
  </div>

  <!-- Statistik -->
  <div id="statistik"></div>

  <!-- Adminbereich -->
  <div id="admin">
    <h3>üîê Adminbereich</h3>
    <input type="password" id="adminpass" placeholder="Passwort">
    <button onclick="adminLogin()">Einloggen</button>
    <div id="adminControls" style="display:none;">
      <button onclick="datenZuruecksetzen()">Punkte zur√ºcksetzen</button>
    </div>
  </div>

  <!-- Modal Gl√ºcksrad -->
  <div id="modalOverlay">
    <div id="modalContent">
      <h3>üéâ Gl√ºckwunsch! Du darfst das Gl√ºcksrad drehen!</h3>
      <div id="svgContainer">
        <div id="zeiger"></div>
        <svg id="svgRad" viewBox="0 0 250 250">
          <g id="radSegmente"></g>
          <circle id="centerCircle" cx="125" cy="125" r="40"/>
        </svg>
      </div>
      <button id="spinBtn" onclick="dreheGluecksradSVG()">üé∞ Jetzt drehen!</button>
      <div id="gewinnPopup">
        <div id="gewinnText"></div>
        <button onclick="hidePopup()">OK</button>
      </div>
    </div>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
  <script>
    // Firebase initialisieren
    firebase.initializeApp({
      apiKey:    "AIzaSyByvnMNMF8zoC5zCCats1Ppyh1-X1nt8Bq4",
      authDomain:"treppenchallenge2025.firebaseapp.com",
      databaseURL:"https://treppenchallenge2025-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "treppenchallenge2025",
      storageBucket:"treppenchallenge2025.appspot.com",
      messagingSenderId:"45698338369",
      appId:     "1:45698338369:web:4aa2c212f2cbea0f0b00c0"
    });
    const db = firebase.database();

    let daten = {}, _lastLeader = null, aktuelleDrehung = 0, currentSpinClass = null;

    const colors = [
      '#e74c3c','#e67e22','#f1c40f','#2ecc71','#1abc9c',
      '#3498db','#9b59b6','#34495e','#16a085','#27ae60',
      '#2980b9','#8e44ad','#2c3e50','#d35400','#c0392b',
      '#f39c12','#8e44ad','#d35400','#e67e22','#e74c3c'
    ];
    let segments = [50,25,10,10, ...Array(8).fill(1), ...Array(5).fill(2), ...Array(4).fill(5)];
    segments.sort(() => Math.random() - 0.5);
    const comments = {
      1:  "üí™ Ein Punkt ist besser als kein Punkt!",
      2:  "üîÅ Weiter so ‚Äì jeder Schritt z√§hlt!",
      5:  "üö∂‚Äç‚ôÇÔ∏è Das summiert sich ‚Äì dranbleiben!",
      10: "üéØ Stark! 10 Bonuspunkte geholt!",
      25: "üèÖ WOW ‚Äì 25 Punkte f√ºr dich!",
      50: "üëë UNGLAUBLICH! 50 Punkte! Du Legende!"
    };

    function getToday() {
      return new Date().toISOString().slice(0,10);
    }

    // Countdown-Display
    const end = new Date("2025-06-18T12:00:00").getTime();
    setInterval(() => {
      const diff = end - Date.now();
      if (diff < 0) {
        document.getElementById("countdown").textContent = "üèÅ Challenge beendet!";
        return;
      }
      const days = Math.floor(diff / 86400000),
            hours = new Date(diff).getUTCHours(),
            mins  = new Date(diff).getUTCMinutes();
      document.getElementById("countdown").textContent =
        `‚è≥ Noch ${days} Tage, ${hours} Stunden, ${mins} Minuten`;
    }, 1000);

    document.addEventListener('DOMContentLoaded', () => {
      // Klassenliste initialisieren
      const kl = [
        "22HD_23HZ_1","22HD_23HZ_2","22HD_23HZ_3","22HD_23HZ_4",
        "22HD_23HZ_5","22HD_23HZ_6","23HD_1","23HD_2","24FZ_1",
        "24FZ_2","24HD_1","24HD_2","24HZ_1","24HZ_2","24HZ_3",
        "24HZ_4","24HZ_5","24HZ_6","25FZ_2","25FZ_3"
      ];
      const sel = document.getElementById('klasse');
      kl.forEach(k => sel.append(Object.assign(
        document.createElement('option'),
        { value: k, textContent: k }
      )));
      sel.append(Object.assign(document.createElement('option'),
        { disabled:true, textContent:'‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ' }
      ));
      sel.append(Object.assign(document.createElement('option'),
        { value:'Lehrerteam', textContent:'üë©‚Äçüè´ Lehrerteam' }
      ));

      zeichneSVGSegmente();

      // Firebase-Daten abh√∂ren
      db.ref('punkte').on('value', snap => {
        daten = snap.val() || {};
        ranglisteAktualisieren();
        statistikAktualisieren();
        const lead = Object.entries(daten).sort((a,b)=>b[1]-a[1])[0]?.[0];
        if (_lastLeader && lead !== _lastLeader) confetti();
        _lastLeader = lead;
      });
      db.ref('daily/' + getToday()).on('value', snap => {
        renderDailyLeaderboard(snap.val() || {});
      });
    });

    // Punkte eintragen
    function punkteSpeichern() {
      const klasse = document.getElementById('klasse').value;
      const punkte = parseInt(document.getElementById('stockwerk').value, 10);
      const out = document.getElementById('output');
      const btn = document.getElementById('enterBtn');
      if (!klasse || isNaN(punkte)) {
        out.textContent = "Bitte alles ausw√§hlen.";
        return;
      }
      const isAdmin = localStorage.getItem('admin') === 'true';
      const last = +localStorage.getItem('lastTime') || 0;
      const now = Date.now();
      if (!isAdmin && now - last < 20 * 60 * 1000) {
        out.textContent = "‚è≥ Bitte warte 20 Minuten.";
        return;
      }
      localStorage.setItem('lastTime', now);
      if (!isAdmin) {
        btn.disabled = true;
        setTimeout(() => btn.disabled = false, 20 * 60 * 1000);
      }
      const neu = (daten[klasse] || 0) + punkte;
      daten[klasse] = neu;
      db.ref('punkte/' + klasse).set(neu);
      db.ref('daily/' + getToday() + '/' + klasse)
        .transaction(v => (v || 0) + punkte);
      out.innerHTML = `<span class="animate-check">‚úÖ ${klasse} hat jetzt ${neu} Punkte.</span>`;
      let cnt = +localStorage.getItem('eintraege') || 0;
      localStorage.setItem('eintraege', ++cnt);
      if (cnt % 10 === 0) {
        currentSpinClass = klasse;
        document.getElementById('gewinnPopup').style.display = 'none';
        document.getElementById('spinBtn').disabled = false;
        document.getElementById('modalOverlay').style.display = 'flex';
      }
    }

    // Tagesbestenliste
    function renderDailyLeaderboard(data) {
      let html = '<h3>üìÖ Tagesbestenliste</h3>';
      Object.entries(data).sort((a,b)=>b[1]-a[1]).forEach(([k,v], i) => {
        const medal = i == 0 ? 'ü•á' : i == 1 ? 'ü•à' : i == 2 ? 'ü•â' : '';
        html += `<p>${medal} ${k}: ${v} Punkte</p>`;
      });
      document.getElementById('dailyLeaderboard').innerHTML = html;
    }

    // Gesamtrangliste + Lehrerliste
    function ranglisteAktualisieren() {
      const schueler = [], lehrer = [];
      Object.entries(daten).forEach(([k,v]) => {
        if (k === 'Lehrerteam') lehrer.push(v);
        else schueler.push([k,v]);
      });
      schueler.sort((a,b)=>b[1]-a[1]);
      let html = '<h3>üèÜ Rangliste</h3>';
      schueler.forEach(([k,v], i) => {
        const medal = i==0?'ü•á':i==1?'ü•à':i==2?'ü•â':'‚ÄÉ';
        html += `<p class="${i==0?'leader':''}">${medal} ${k}: ${v} Punkte</p>`;
      });
      document.getElementById('leaderboard').innerHTML = html;
      document.getElementById('lehrerliste').innerHTML =
        `<h3>üìö Lehrpersonen</h3>
         <p>üë®‚Äçüè´ Lehrerteam: ${lehrer[0]||0} Punkte (au√üer Konkurrenz)</p>`;
    }

    // Gesamtstatistik
    function statistikAktualisieren() {
      const total = Object.values(daten).reduce((a,b)=>a+b, 0);
      const schritte = total * 20;
      const kcal = (total * 0.17).toFixed(1);
      const hm   = (total * 3.3).toFixed(1);
      document.getElementById('statistik').textContent =
        `üö∂‚Äç‚ôÇÔ∏è ${total} Stockwerke ‚Üí ${schritte} Schritte | üî• ${kcal} kcal | üóª ${hm} H√∂henmeter`;
    }

    // Confetti-Animation
    function confetti() {
      const cols = ['#f44336','#ffeb3b','#4caf50','#2196f3','#9c27b0','#ff9800','#03a9f4','#8bc34a'];
      for (let i = 0; i < 150; i++) {
        const d = document.createElement('div');
        const sz = 4 + Math.random() * 8;
        Object.assign(d.style, {
          position:'fixed', width:`${sz}px`, height:`${sz}px`,
          background: cols[Math.floor(Math.random()*cols.length)],
          borderRadius:'50%', top:`${Math.random()*100}%`, left:`${Math.random()*100}%`,
          pointerEvents:'none', opacity:'1', zIndex:1000,
          transition:'opacity 1s ease-out,transform 1s ease-out'
        });
        document.body.appendChild(d);
        setTimeout(()=>{
          d.style.transform = `translateY(-${20+Math.random()*50}px)`;
          d.style.opacity = '0';
        }, 50);
        setTimeout(()=>d.remove(), 1200 + Math.random()*600);
      }
    }

    // Gl√ºcksrad zeichnen
    function zeichneSVGSegmente() {
      const g = document.getElementById('radSegmente');
      const cx = 125, cy = 125, r = 120, n = segments.length;
      g.innerHTML = '';
      segments.forEach((w,i) => {
        const start = 360/n*i, end = start + 360/n;
        const x1 = cx + r*Math.cos(Math.PI/180*start);
        const y1 = cy + r*Math.sin(Math.PI/180*start);
        const x2 = cx + r*Math.cos(Math.PI/180*end);
        const y2 = cy + r*Math.sin(Math.PI/180*end);
        const path = document.createElementNS('http://www.w3.org/2000/svg','path');
        path.setAttribute('d', `M${cx},${cy} L${x1},${y1} A${r},${r} 0 0,1 ${x2},${y2} Z`);
        path.setAttribute('fill', colors[i % colors.length]);
        path.setAttribute('stroke','#fff');
        path.setAttribute('stroke-width','2');
        g.appendChild(path);
        const mid = (start+end)/2;
        const tx = cx + (r-20)*Math.cos(Math.PI/180*mid);
        const ty = cy + (r-20)*Math.sin(Math.PI/180*mid);
        const text = document.createElementNS('http://www.w3.org/2000/svg','text');
        text.setAttribute('x', tx);
        text.setAttribute('y', ty);
        text.setAttribute('transform', `rotate(${mid},${tx},${ty})`);
        text.setAttribute('text-anchor','middle');
        text.setAttribute('alignment-baseline','middle');
        text.setAttribute('font-size','12');
        text.setAttribute('fill','#fff');
        text.textContent = w;
        g.appendChild(text);
      });
    }

    function getSegmentIndex(rot, count=20) {
      let r = rot % 360; if (r < 0) r += 360;
      const ptr = 270, loc = (ptr - r + 360) % 360;
      return Math.floor(loc / (360 / count));
    }

    // Dreh-Logik
    function dreheGluecksradSVG() {
      if (!currentSpinClass) return;
      document.getElementById('spinBtn').disabled = true;
      document.getElementById('gewinnPopup').style.display = 'none';
      document.getElementById('gewinnText').innerHTML = '';
      const n = segments.length, base = 360/n;
      const spins = 4 + Math.random()*2, offset = Math.random()*base;
      aktuelleDrehung += spins*360 + offset;
      const wheel = document.getElementById('svgRad');
      wheel.style.transform = `rotate(${aktuelleDrehung}deg)`;
      wheel.addEventListener('transitionend', () => {
        const idx = getSegmentIndex(aktuelleDrehung, n);
        const gew = segments[idx];
        const alt = daten[currentSpinClass] || 0;
        const neu = alt + gew;
        db.ref('punkte/' + currentSpinClass).set(neu);
        document.getElementById('gewinnText').innerHTML =
          `${comments[gew]}<br><strong>+${gew} Punkte</strong> f√ºr ${currentSpinClass}!`;
        document.getElementById('gewinnPopup').style.display = 'block';
      }, { once:true });
    }

    function hidePopup() {
      document.getElementById('modalOverlay').style.display = 'none';
      currentSpinClass = null;
    }

    // Admin-Login
    function adminLogin() {
      if (document.getElementById('adminpass').value === 'Bistroboykott') {
        localStorage.setItem('admin','true');
        document.getElementById('adminControls').style.display = 'block';
        document.getElementById('enterBtn').disabled = false;
      } else {
        alert('Falsches Passwort');
      }
    }

    // Punkte zur√ºcksetzen
    function datenZuruecksetzen() {
      if (confirm('Punkte wirklich zur√ºcksetzen?')) {
        db.ref('punkte').remove();
        localStorage.removeItem('eintraege');
        localStorage.removeItem('lastTime');
        alert('Punkte zur√ºckgesetzt.');
      }
    }
  </script>
</body>
</html>

