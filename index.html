<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Treppen-Challenge</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      padding: 2em;
      background: linear-gradient(to bottom, #e0f7fa, #ffffff);
      color: #333;
      max-width: 700px;
      margin: auto;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    header img {
      max-height: 100px; display: block; margin: auto;
    }
    h1 {
      color: #00796b; text-align: center;
    }
    select, button, input {
      display: block; margin: 1em auto;
      font-size: 1.1em; padding: 0.4em;
    }
    button {
      background-color: #00796b; color: white;
      border: none; border-radius: 4px; cursor: pointer;
    }
    button:hover { background-color: #004d40; }
    button:disabled {
      background: #ccc !important; cursor: not-allowed !important;
    }
    #output, #statistik, #countdown, #leaderboard, #admin {
      text-align: center; margin-top: 1em;
    }
    .animate-check {
      animation: bounce 0.6s; display: inline-block;
    }
    @keyframes bounce {
      0% { transform: scale(1); }
      50% { transform: scale(1.3); }
      100% { transform: scale(1); }
    }
    .leader {
      font-weight: bold; color: gold;
      animation: glow 1s infinite alternate;
    }
    @keyframes glow {
      from { text-shadow: 0 0 10px gold; }
      to   { text-shadow: 0 0 20px orange; }
    }
    /* Rad-Container */
    #svgContainer {
      position: relative; width: 280px; height: 280px;
      margin: 2em auto; padding: 5px;
      border: 5px solid #00796b; border-radius: 50%;
      box-sizing: content-box;
    }
    /* Pfeil oben */
    #zeiger {
      position: absolute; top: -30px; left: 50%;
      transform: translateX(-50%);
      border-left: 20px solid transparent;
      border-right:20px solid transparent;
      border-top: 30px solid #333; z-index: 2;
    }
    /* Wheel */
    #svgRad {
      width: 100%; height:100%;
      border-radius:50%;
      transition: transform 5s ease-out;
    }
    #centerCircle {
      fill: #fff; stroke: #333; stroke-width: 4;
    }
    /* Popup */
    #gewinnPopup {
      display: none; position: fixed;
      top:50%; left:50%; transform:translate(-50%,-50%);
      background:#fff; border:3px solid #00796b;
      border-radius:12px; padding:1em 2em; text-align:center;
      box-shadow:0 0 20px rgba(0,0,0,0.2); z-index:999;
    }
    #gewinnPopup button {
      margin-top:1em; padding:.5em 1.5em;
      background:#00796b; color:#fff; border:none;
      border-radius:4px; cursor:pointer;
    }
    #gluecksrad {
      display: none; text-align:center; margin-top:2em;
    }
  </style>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
</head>
<body>
  <header><img src="https://i.postimg.cc/2qZmLMft/Xund-Treppen-logo.png" alt="Logo"></header>
  <h1>Treppen-Challenge</h1>
  <div id="countdown"></div>

  <label for="klasse">W√§hle deine Klasse:</label>
  <select id="klasse">
    <option value="">--Bitte w√§hlen--</option>
  </select>

  <label for="stockwerk">Angekommen im Stockwerk:</label>
  <select id="stockwerk">
    <option value="">-- Bitte w√§hlen --</option>
    <option value="1">1. Stock (1 Punkt)</option>
    <option value="2">2. Stock (2 Punkte)</option>
    <option value="3">3. Stock (3 Punkte)</option>
    <option value="4">4. Stock (4 Punkte)</option>
  </select>
  <button id="enterBtn" onclick="punkteSpeichern()">Punkte eintragen</button>

  <div id="output"></div>
  <div id="leaderboard"></div>
  <div id="statistik"></div>

  <div id="gluecksrad">
    <h3>üéâ Gl√ºckwunsch! Du darfst das Gl√ºcksrad drehen!</h3>
    <div id="svgContainer">
      <div id="zeiger"></div>
      <svg id="svgRad" viewBox="0 0 250 250">
        <g id="radSegmente"></g>
        <circle id="centerCircle" cx="125" cy="125" r="40"/>
      </svg>
    </div>
    <button onclick="dreheGluecksradSVG()">üé∞ Jetzt drehen!</button>
    <div id="gewinnPopup">
      <div id="gewinnText"></div>
      <button onclick="hidePopup()">OK</button>
    </div>
  </div>

  <div id="admin">
    <h3>üîê Adminbereich</h3>
    <input type="password" id="adminpass" placeholder="Passwort">
    <button onclick="adminLogin()">Einloggen</button>
    <div id="adminControls" style="display:none;">
      <button onclick="datenZuruecksetzen()">Punkte zur√ºcksetzen</button>
    </div>
  </div>

  <script>
    // --- Firebase init ---
    firebase.initializeApp({
      apiKey: "AIzaSyByvnMNMF8zoC5zCCats1Ppyh1-X1nt8Bq4",
      authDomain: "treppenchallenge2025.firebaseapp.com",
      databaseURL: "https://treppenchallenge2025-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "treppenchallenge2025",
      storageBucket: "treppenchallenge2025.appspot.com",
      messagingSenderId: "45698338369",
      appId: "1:45698338369:web:4aa2c212f2cbea0f0b00c0"
    });
    const db = firebase.database();

    let daten = {}, _lastLeader = null,
        aktuelleDrehung = 0, currentSpinClass = null;

    const colors = [
      '#e74c3c','#2980b9','#27ae60','#f39c12','#8e44ad',
      '#d35400','#16a085','#c0392b','#2c3e50','#7f8c8d',
      '#d81b60','#0097a7','#f06292','#4db6ac','#ba68c8',
      '#ff8a65','#aed581','#7986cb','#ffb74d','#a1887f'
    ];
    let segments = [
      50,25,10,10,
      ...Array(8).fill(1),
      ...Array(5).fill(2),
      ...Array(4).fill(5)
    ];
    for (let i = segments.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [segments[i], segments[j]] = [segments[j], segments[i]];
    }
    const comments = {
      1: "üí™ Ein Punkt ist besser als kein Punkt!",
      2: "üîÅ Weiter so ‚Äì jeder Schritt z√§hlt!",
      5: "üö∂‚Äç‚ôÇÔ∏è Das summiert sich ‚Äì dranbleiben!",
      10:"üéØ Stark! 10 Bonuspunkte geholt!",
      25:"üèÖ WOW ‚Äì 25 Punkte f√ºr dich!",
      50:"üëë UNGLAUBLICH! 50 Punkte! Du Legende!"
    };

    // --- Countdown ---
    const enddatum = new Date("2025-06-18T12:00:00").getTime();
    setInterval(() => {
      const now = Date.now(), diff = enddatum - now;
      if (diff < 0) {
        document.getElementById("countdown").textContent = "üèÅ Challenge beendet!";
        return;
      }
      const tage = Math.floor(diff/(1000*60*60*24)),
            stunden = new Date(diff).getUTCHours(),
            minuten = new Date(diff).getUTCMinutes();
      document.getElementById("countdown").textContent =
        `‚è≥ Noch ${tage} Tage, ${stunden} Stunden, ${minuten} Minuten`;
    }, 1000);

    // --- DOM ready ---
    document.addEventListener('DOMContentLoaded', () => {
      // Klassen-Dropdown
      const klassen = [
        "22HD_23HZ_1","22HD_23HZ_2","22HD_23HZ_3","22HD_23HZ_4",
        "22HD_23HZ_5","22HD_23HZ_6","23HD_1","23HD_2","24FZ_1",
        "24FZ_2","24HD_1","24HD_2","24HZ_1","24HZ_2","24HZ_3",
        "24HZ_4","24HZ_5","24HZ_6","25FZ_2","25FZ_3"
      ];
      const selK = document.getElementById('klasse');
      klassen.forEach(k=>{
        const o = document.createElement('option');
        o.value = k; o.textContent = k;
        selK.appendChild(o);
      });

      // Wheel zeichnen
      zeichneSVGSegmente();

      // 20-Min-Lock initial und stock param
      const isAdmin = localStorage.getItem('admin')==='true';
      const last = +localStorage.getItem('lastTime')||0;
      const now = Date.now();
      const enterBtn = document.getElementById('enterBtn');
      // Lock Button
      if (!isAdmin && now - last < 1_200_000) {
        enterBtn.disabled = true;
        setTimeout(() => enterBtn.disabled = false, 1_200_000 - (now - last));
      }
      // URL-Param stock blockieren
      const params = new URLSearchParams(window.location.search);
      const stockParam = params.get('stock');
      if (['1','2','3','4'].includes(stockParam)) {
        const selS = document.getElementById('stockwerk');
        selS.value = stockParam;
        selS.disabled = true;
      }

      // Firebase Listener
      db.ref('punkte').on('value', snap => {
        daten = snap.val()||{};
        ranglisteAktualisieren();
        statistikAktualisieren();
        const lead = Object.entries(daten).sort((a,b)=>b[1]-a[1])[0]?.[0];
        if (_lastLeader === null) _lastLeader = lead;
        else if (lead && lead!==_lastLeader) {
          _lastLeader = lead;
          confetti();
        }
      });
    });

    // --- Punkte eintragen ---
    function punkteSpeichern() {
      const k = document.getElementById('klasse').value;
      const s = parseInt(document.getElementById('stockwerk').value);
      const out = document.getElementById('output');
      if (!k || isNaN(s)) {
        out.textContent = "Bitte alles ausw√§hlen.";
        return;
      }
      const isAdmin = localStorage.getItem('admin')==='true';
      const last = +localStorage.getItem('lastTime')||0;
      const now = Date.now();
      const btn = document.getElementById('enterBtn');
      if (!isAdmin && now - last < 1_200_000) {
        out.textContent = "‚è≥ Bitte warte 20 Minuten.";
        return;
      }
      localStorage.setItem('lastTime', now);
      if (!isAdmin) {
        btn.disabled = true;
        setTimeout(() => btn.disabled = false, 1_200_000);
      }
      const alt = daten[k]||0, neu = alt+s;
      db.ref('punkte/'+k).set(neu);
      out.innerHTML = `<span class="animate-check">‚úÖ Klasse ${k} hat jetzt ${neu} Punkte.</span>`;
      let count = +localStorage.getItem('eintraege')||0; count++;
      localStorage.setItem('eintraege', count);
      if ([10,20,50,100].includes(count)) {
        currentSpinClass = k;
        document.getElementById('gluecksrad').style.display = 'block';
      }
    }

    // --- Rangliste & Statistik ---
    function ranglisteAktualisieren() {
      const arr = Object.entries(daten).sort((a,b)=>b[1]-a[1]);
      let html = '<h3>üèÜ Rangliste</h3>';
      arr.forEach(([k,v], i) => {
        const pok = i==0?'ü•á':i==1?'ü•à':i==2?'ü•â':'‚ÄÉ';
        html += `<p class="${i==0?'leader':''}">${pok} ${k}: ${v} Punkte</p>`;
      });
      document.getElementById('leaderboard').innerHTML = html;
    }
    function statistikAktualisieren() {
      const total = Object.values(daten).reduce((a,b)=>a+b,0);
      document.getElementById('statistik').textContent =
        `üö∂‚Äç‚ôÇÔ∏è ${total} Stockwerke ‚Üí ${total*20} Schritte | üî• ${(total*0.17).toFixed(1)} kcal | üóª ${(total*3.3).toFixed(1)} hm`;
    }

    // --- Confetti ---
    function confetti() {
      const cols = ['#f44336','#ffeb3b','#4caf50','#2196f3','#9c27b0','#ff9800','#03a9f4','#8bc34a'];
      for (let i=0; i<150; i++){
        const d = document.createElement('div'), size=4+Math.random()*8;
        Object.assign(d.style,{
          position:'fixed',width:`${size}px`,height:`${size}px`,
          background:cols[Math.floor(Math.random()*cols.length)],
          borderRadius:'50%',top:`${Math.random()*100}%`,left:`${Math.random()*100}%`,
          pointerEvents:'none',opacity:'1',zIndex:1000,
          transition:'opacity 1s ease-out,transform 1s ease-out'
        });
        document.body.appendChild(d);
        setTimeout(()=>{
          d.style.transform=`translateY(-${20+Math.random()*50}px)`;
          d.style.opacity='0';
        },50);
        setTimeout(()=>d.remove(),1200+Math.random()*600);
      }
    }

    // --- Wheel render & Drehung ---
    function zeichneSVGSegmente(){
      const g=document.getElementById('radSegmente'),
            n=segments.length, cx=125, cy=125, r=120;
      g.innerHTML='';
      segments.forEach((w,i)=>{
        const start=(360/n)*i, end=start+(360/n);
        const x1=cx+r*Math.cos(Math.PI/180*start),
              y1=cy+r*Math.sin(Math.PI/180*start),
              x2=cx+r*Math.cos(Math.PI/180*end),
              y2=cy+r*Math.sin(Math.PI/180*end);
        const p=document.createElementNS('http://www.w3.org/2000/svg','path');
        p.setAttribute('d',`M${cx},${cy} L${x1},${y1} A${r},${r} 0 0,1 ${x2},${y2} Z`);
        p.setAttribute('fill',colors[i%colors.length]); g.appendChild(p);
        const mid=(start+end)/2,
              tx=cx+(r-20)*Math.cos(Math.PI/180*mid),
              ty=cy+(r-20)*Math.sin(Math.PI/180*mid),
              t=document.createElementNS('http://www.w3.org/2000/svg','text');
        t.setAttribute('x',tx); t.setAttribute('y',ty);
        t.setAttribute('transform',`rotate(${mid},${tx},${ty})`);
        t.setAttribute('text-anchor','middle'); t.setAttribute('alignment-baseline','middle');
        t.setAttribute('font-size','12'); t.setAttribute('fill','#fff');
        t.textContent=w; g.appendChild(t);
      });
    }
    function getSegmentIndex(rotationDeg,count=20){
      let rot=rotationDeg%360; if(rot<0)rot+=360;
      const pointer=270, local=(pointer-rot+360)%360, size=360/count;
      return Math.floor(local/size);
    }
    function dreheGluecksradSVG(){
      if(!currentSpinClass)return;
      const n=segments.length, base=360/n;
      const spins=4+Math.random()*2, offset=Math.random()*base;
      aktuelleDrehung+=spins*360+offset;
      const w=document.getElementById('svgRad');
      w.style.transform=`rotate(${aktuelleDrehung}deg)`;
      w.addEventListener('transitionend',()=>{
        const idx=getSegmentIndex(aktuelleDrehung,n),
              gew=segments[idx], alt=daten[currentSpinClass]||0, neu=alt+gew;
        db.ref('punkte/'+currentSpinClass).set(neu);
        document.getElementById('gewinnText').innerHTML=
          `${comments[gew]}<br><strong>+${gew} Punkte</strong> f√ºr ${currentSpinClass}!`;
        document.getElementById('gewinnPopup').style.display='block';
      },{once:true});
    }
    function hidePopup(){
      document.getElementById('gewinnPopup').style.display='none';
      document.getElementById('gluecksrad').style.display='none';
      currentSpinClass=null;
    }

    // --- Admin & Reset ---
    function adminLogin(){
      if(document.getElementById('adminpass').value==='Bistroboykott'){
        localStorage.setItem('admin','true');
        document.getElementById('adminControls').style.display='block';
      } else alert('Falsches Passwort');
    }
    function datenZuruecksetzen(){
      if(!confirm('Punkte wirklich zur√ºcksetzen?'))return;
      db.ref('punkte').remove();
      localStorage.removeItem('eintraege');
      localStorage.removeItem('lastTime');
      alert('Punkte zur√ºckgesetzt.');
    }

  </script>
</body>
</html>

